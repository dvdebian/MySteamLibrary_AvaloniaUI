<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MySteamLibrary.ViewModels"
             xmlns:models="using:MySteamLibrary.Models"
             xmlns:conv="using:MySteamLibrary.Converters"
             xmlns:views="using:MySteamLibrary.Views"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="MySteamLibrary.Views.CarouselView"
             x:DataType="vm:CarouselViewModel"
             x:Name="RootCarouselView">

    <UserControl.Resources>
        <conv:BitmapValueConverter x:Key="VariableImageConverter"/>
        <conv:CenterPaddingConverter x:Key="CenterPaddingConverter"/>
        <conv:CarouselTransformConverter x:Key="CarouselTransformConverter"/>
        <conv:SelectedZIndexConverter x:Key="SelectedZIndexConverter"/>
        <conv:DynamicItemMarginConverter x:Key="DynamicItemMarginConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <Style Selector="Border.CarouselCard Border#CardVisual">
            <Setter Property="BoxShadow" Value="0 5 15 0 #88000000"/>
            <Setter Property="BorderBrush">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="#707070" Offset="0"/>
                        <GradientStop Color="#A0A0A0" Offset="0.3"/>
                        <GradientStop Color="#D0D0D0" Offset="0.5"/>
                        <GradientStop Color="#A0A0A0" Offset="0.7"/>
                        <GradientStop Color="#707070" Offset="1"/>
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="Opacity" Value="1.0"/>
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.4" Easing="CircularEaseOut"/>
                    <BoxShadowsTransition Property="BoxShadow" Duration="0:0:0.25" Easing="CubicEaseOut"/>
                    <BrushTransition Property="BorderBrush" Duration="0:0:0.25"/>
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="Border.CarouselCard.Selected Border#CardVisual">
            <Setter Property="BoxShadow" Value="0 20 40 5 #AA000000"/>
            <Setter Property="BorderBrush">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="#A0A0A0" Offset="0"/>
                        <GradientStop Color="#D0D0D0" Offset="0.3"/>
                        <GradientStop Color="#FFFFFF" Offset="0.5"/>
                        <GradientStop Color="#D0D0D0" Offset="0.7"/>
                        <GradientStop Color="#A0A0A0" Offset="1"/>
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="Opacity" Value="1.0"/>
        </Style>

        <!-- Effect Overlay Styles -->
        <Style Selector="Button.EffectArrow">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.2"/>
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="Button.EffectArrow:pointerover">
            <Setter Property="Opacity" Value="0.7"/>
        </Style>
    </UserControl.Styles>

    <Grid x:Name="MainGrid">
        <!-- Dual Blurred Backgrounds for True Crossfade -->
        <Grid x:Name="BackgroundLayer" ClipToBounds="False">
            <!-- Background Image 1 (Bottom Layer) -->
            <Image x:Name="BackgroundImage1"
                   Stretch="UniformToFill"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   Opacity="1">
                <Image.Effect>
                    <BlurEffect Radius="80"/>
                </Image.Effect>
            </Image>
            
            <!-- Background Image 2 (Top Layer for crossfade) -->
            <Image x:Name="BackgroundImage2"
                   Stretch="UniformToFill"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   Opacity="0">
                <Image.Effect>
                    <BlurEffect Radius="80"/>
                </Image.Effect>
            </Image>
            
            <!-- Dark overlay for better readability -->
            <Border Background="#AA000000"/>
        </Grid>

        <ScrollViewer x:Name="CarouselScroller"
                      Background="Transparent"
                      HorizontalScrollBarVisibility="Hidden"
                      VerticalScrollBarVisibility="Disabled"
                      PointerWheelChanged="OnPointerWheelChanged"
                      Focusable="True"
                      ClipToBounds="False"
                      VerticalAlignment="Stretch"
                      HorizontalAlignment="Stretch">

            <ScrollViewer.Transitions>
                <Transitions>
                    <VectorTransition Property="Offset" Duration="0:0:0.4" Easing="CubicEaseOut"/>
                </Transitions>
            </ScrollViewer.Transitions>

            <Border Padding="{Binding Bounds.Width, 
                               RelativeSource={RelativeSource AncestorType=UserControl}, 
                               Converter={StaticResource CenterPaddingConverter}}"
                    Margin="0"
                    VerticalAlignment="Center"
                    ClipToBounds="False">

                <ItemsRepeater x:Name="CarouselRepeater"
                               ItemsSource="{Binding Games}"
                               ClipToBounds="False"
                               VerticalAlignment="Center">

                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Horizontal" 
                                     Spacing="10"/>
                    </ItemsRepeater.Layout>

                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="models:GameModel">
                            <Border Width="220" 
                                    Height="330"
                                    Classes="CarouselCard"
                                    Margin="{Binding Bounds.Width, RelativeSource={RelativeSource AncestorType=views:CarouselView}, Converter={StaticResource DynamicItemMarginConverter}}"
                                    VerticalAlignment="Center" 
                                    ClipToBounds="False">
                                    
                                <Border.ZIndex>
                                    <MultiBinding Converter="{StaticResource SelectedZIndexConverter}">
                                        <Binding />
                                        <Binding Path="CurrentSelectedGame" RelativeSource="{RelativeSource AncestorType=views:CarouselView}"/>
                                    </MultiBinding>
                                </Border.ZIndex>

                                <Panel Width="220" Height="330" VerticalAlignment="Center" ClipToBounds="False">
                                    <Border Name="CardVisual"
                                            Width="220" Height="330" 
                                            Background="#2a2e33" 
                                            VerticalAlignment="Center"
                                            CornerRadius="12" 
                                            ClipToBounds="False" 
                                            PointerPressed="OnCoverClicked">
                                        
                                        <Border.RenderTransformOrigin>50%,50%</Border.RenderTransformOrigin>
                                        
                                        <Border.RenderTransform>
                                            <MultiBinding Converter="{StaticResource CarouselTransformConverter}">
                                                <Binding /> 
                                                <Binding Path="CurrentSelectedGame" RelativeSource="{RelativeSource AncestorType=views:CarouselView}"/>
                                                <Binding Path="ItemsSource" ElementName="CarouselRepeater"/>
                                                <Binding Path="Bounds" RelativeSource="{RelativeSource AncestorType=views:CarouselView}"/>
                                            </MultiBinding>
                                        </Border.RenderTransform>
                                        
                                        <Border.Transitions>
                                            <Transitions>
                                                <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.4" Easing="CubicEaseOut"/>
                                            </Transitions>
                                        </Border.Transitions>

                                        <Border CornerRadius="10" ClipToBounds="True">
                                            <Image Source="{Binding ImagePath, Converter={StaticResource VariableImageConverter}}" 
                                                   Stretch="UniformToFill"/>
                                        </Border>
                                    </Border>
                                </Panel>
                            </Border>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </Border>
        </ScrollViewer>

        <!-- Canvas Overlay for Floating Title -->
        <Canvas x:Name="TitleOverlay"
                IsHitTestVisible="False"
                VerticalAlignment="Stretch"
                HorizontalAlignment="Stretch">
            
            <StackPanel x:Name="TitlePanel"
                        Canvas.Top="0"
                        Width="{Binding Bounds.Width, ElementName=TitleOverlay}"
                        Spacing="5">
                
                <TextBlock x:Name="TitleText"
                           Text="{Binding CurrentSelectedGame.Title, RelativeSource={RelativeSource AncestorType=views:CarouselView}}"
                           FontSize="32"
                           FontWeight="ExtraBold"
                           Foreground="White"
                           TextAlignment="Center" 
                           HorizontalAlignment="Stretch"
                           TextWrapping="NoWrap"
                           Margin="20,-10,20,0"/>
                
                <TextBlock x:Name="PlayTimeText"
                           Text="{Binding CurrentSelectedGame.PlayTime, StringFormat='{}{0} HOURS PLAYED', RelativeSource={RelativeSource AncestorType=views:CarouselView}}"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#99ffffff"
                           TextAlignment="Center"
                           HorizontalAlignment="Stretch"
                           LetterSpacing="2"
                           Margin="20,0,20,10"/>
            </StackPanel>
            
            <!-- Smooth transition for vertical position changes -->
            <Canvas.Transitions>
                <Transitions>
                    <DoubleTransition Property="Canvas.Top" Duration="0:0:0.4" Easing="CubicEaseOut"/>
                </Transitions>
            </Canvas.Transitions>
        </Canvas>


        <!-- Effect Selector Overlay -->
        <Border
                Background="#CC000000"
                IsVisible="{Binding IsEffectOverlayVisible, ElementName=RootCarouselView}"
                IsHitTestVisible="{Binding IsEffectOverlayVisible, ElementName=RootCarouselView}">
            
            <Grid VerticalAlignment="Bottom" Margin="0,0,0,40">
                <Border Background="#1b2838"
                        CornerRadius="8"
                        Padding="30,20"
                        HorizontalAlignment="Center"
                        BoxShadow="0 8 24 0 #AA000000">
                    
                    <StackPanel Spacing="15">
                        <TextBlock Text="CAROUSEL EFFECT"
                                   FontSize="13"
                                   FontWeight="Bold"
                                   Foreground="#67c1f5"
                                   HorizontalAlignment="Center"
                                   LetterSpacing="1"/>
                        
                        <Grid ColumnDefinitions="Auto,*,Auto" 
                              Width="400"
                              HorizontalAlignment="Center">
                            
                            <!-- Previous Button -->
                            <Button Classes="EffectArrow"
                                    Grid.Column="0"
                                    Click="OnPreviousEffectClicked"
                                    ToolTip.Tip="Previous Effect">
                                <Path Data="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"
                                      Fill="White"
                                      Stretch="Uniform"
                                      Width="24"/>
                            </Button>

                            <!-- Effect Name -->
                            <TextBlock Grid.Column="1"
                                       Text="{Binding CurrentEffectName, ElementName=RootCarouselView}"
                                       FontSize="24"
                                       FontWeight="ExtraBold"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       LetterSpacing="2"/>

                            <!-- Next Button -->
                            <Button Classes="EffectArrow"
                                    Grid.Column="2"
                                    Click="OnNextEffectClicked"
                                    ToolTip.Tip="Next Effect">
                                <Path Data="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"
                                      Fill="White"
                                      Stretch="Uniform"
                                      Width="24"/>
                            </Button>
                        </Grid>

                        <!-- Close Button -->
                        <Button Content="CLOSE"
                          
                                Click="OnEffectToggleClicked"
                                  HorizontalAlignment="Center"
                            HorizontalContentAlignment="Center"
                            Background="#2a475e"
                            Foreground="White"
                            BorderBrush="#67c1f5"
                            BorderThickness="0"
                            CornerRadius="4"
                            Padding="20,10"
                            FontSize="12"
                            FontWeight="SemiBold"
                            Cursor="Hand">
                        <Button.Styles>
                            <Style Selector="Button:pointerover">
                                <Setter Property="Background" Value="#3a5770"/>
                            </Style>
                        </Button.Styles>
                    </Button>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
