<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MySteamLibrary.ViewModels"
             xmlns:models="using:MySteamLibrary.Models"
             xmlns:conv="using:MySteamLibrary.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="MySteamLibrary.Views.CarouselView"
             x:DataType="vm:CarouselViewModel"
             Name="RootView">

    <UserControl.Resources>
        <conv:BitmapValueConverter x:Key="VariableImageConverter"/>
        <conv:CenterPaddingConverter x:Key="CenterPaddingConverter"/>
        <conv:CarouselTransformConverter x:Key="CarouselTransformConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <Style Selector="ItemsRepeater > ContentPresenter">
            <Setter Property="ZIndex" Value="1"/>
            <Setter Property="ClipToBounds" Value="False"/>
        </Style>

        <Style Selector="Border#CardVisual">
            <Setter Property="BoxShadow" Value="0 5 15 0 #88000000"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Opacity" Value="1.0"/>
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.4" Easing="CircularEaseOut"/>
                    <BoxShadowsTransition Property="BoxShadow" Duration="0:0:0.25" Easing="CubicEaseOut"/>
                    <BrushTransition Property="BorderBrush" Duration="0:0:0.25"/>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.3"/>
                </Transitions>
            </Setter>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="1*, 400, 1*">
        <ScrollViewer Name="PART_ScrollViewer"
                      Grid.Row="1"
                      HorizontalAlignment="Stretch"
                      HorizontalScrollBarVisibility="Hidden"
                      VerticalScrollBarVisibility="Disabled"
                      ClipToBounds="False">

            <ScrollViewer.Transitions>
                <Transitions>
                    <VectorTransition Property="Offset" Duration="0:0:0.4" Easing="CubicEaseOut"/>
                </Transitions>
            </ScrollViewer.Transitions>

            <Border HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Background="Transparent"
                    Padding="{Binding Bounds.Width, ElementName=RootView, Converter={StaticResource CenterPaddingConverter}}">

                <ItemsRepeater Name="CarouselRepeater"
                               ItemsSource="{Binding Games}"
                               HorizontalAlignment="Left"
                               VerticalAlignment="Stretch"
                               Background="Transparent"
                               HorizontalCacheLength="100"
                               PointerWheelChanged="OnPointerWheelChanged">

                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Horizontal" Spacing="10"/>
                    </ItemsRepeater.Layout>

                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="models:GameModel">
                            <Panel Width="220" Height="330" VerticalAlignment="Center" ClipToBounds="False">
                                <Border Name="CardVisual"
                                        Width="220" Height="330" 
                                        Background="#2a2e33" 
                                        CornerRadius="12" 
                                        ClipToBounds="False" 
                                        PointerPressed="OnCoverClicked">

                                    <Border.RenderTransformOrigin>50%,50%</Border.RenderTransformOrigin>
                                    
                                    <Border.RenderTransform>
                                        <MultiBinding Converter="{StaticResource CarouselTransformConverter}">
                                            <Binding /> 
                                            <Binding Path="$parent[Window].((vm:MainViewModel)DataContext).SelectedGame" />
                                            <Binding Path="#RootView.DataContext.Games" />
                                            <Binding Path="#RootView.Bounds" />
                                        </MultiBinding>
                                    </Border.RenderTransform>

                                    <Border CornerRadius="12" ClipToBounds="True">
                                        <Image Source="{Binding ImagePath, Converter={StaticResource VariableImageConverter}}" 
                                               Stretch="UniformToFill"/>
                                    </Border>
                                </Border>
                            </Panel>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </Border>
        </ScrollViewer>

        <StackPanel Grid.Row="2"
                    VerticalAlignment="Top"
                    Margin="0,-40,0,0" 
                    HorizontalAlignment="Center"
                    Spacing="5" 
                    IsHitTestVisible="False">

            <TextBlock Text="{Binding $parent[Window].((vm:MainViewModel)DataContext).SelectedGame.Title}" 
                       FontSize="32" 
                       FontWeight="ExtraBold"
                       Foreground="White"
                       TextAlignment="Center"/>

            <TextBlock Text="{Binding $parent[Window].((vm:MainViewModel)DataContext).SelectedGame.PlayTime, StringFormat='{}{0} HOURS PLAYED'}" 
                       FontSize="14" 
                       FontWeight="SemiBold"
                       Foreground="#99ffffff"
                       TextAlignment="Center"
                       LetterSpacing="2"/>
        </StackPanel>
    </Grid>
</UserControl>